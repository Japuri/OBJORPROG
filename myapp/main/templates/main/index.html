{% load static %}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAUspital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhfR+UXS7IVjUGVsAA+x9saKkHQ+3yL1okNs="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

   <style>
    /* Main container for the two-column layout */
    .map-layout-container {
        display: flex;
        flex-direction: column; /* Mobile-first: stack columns */
        height: 600px;
        border-radius: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        background: #fff;

        /* FIX: Establish a positioning context to control child elements */
        position: relative;
        overflow: hidden; /* This is also very important */
    }
    /* On large screens, switch to side-by-side columns */
    @media (min-width: 1024px) {
        .map-layout-container {
            flex-direction: row;
        }
    }

    /* Sidebar for the list of hospitals */
    #results-list-container {
        flex-basis: 33.333333%; /* 1/3 width on desktop */
        height: 250px;
        overflow-y: auto;
        border-bottom: 1px solid #e5e7eb;

        /* FIX: Ensure sidebar is on a higher "layer" than the map */
        z-index: 10;
        background-color: #ffffff; /* Explicit background to prevent transparency issues */
    }
    @media (min-width: 1024px) {
        #results-list-container {
            height: 100%;
            border-right: 1px solid #e5e7eb;
            border-bottom: none;
        }
    }

    /* Container for the map itself */
    #map-container {
        flex-basis: 66.666667%; /* 2/3 width on desktop */
        height: 350px;

        /* FIX: Give map a lower "layer" and contain it */
        position: relative;
        z-index: 5;
    }
    @media (min-width: 1024px) {
        #map-container {
            height: 100%;
        }
    }
    #map {
        width: 100%;
        height: 100%;
    }

    /* Styling for individual items in the results list */
    .result-item {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    .result-item:hover, .result-item.highlighted {
        background-color: #f3f4f6;
    }
    .result-item-name {
        font-weight: 600;
        color: #111827;
    }
    .result-item-address {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
</style>
</head>
<body class="antialiased" data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}">
    <input type="hidden" name="csrfmiddlewaretoken" id="csrf_token_input" value="{{ csrf_token }}">

    <nav class="bg-white shadow-md py-4 px-6 md:px-12 lg:px-24 rounded-b-xl">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{% url 'home' %}" class="text-2xl font-bold text-indigo-700 hover:text-indigo-900">HAUspital</a>
            <div class="hidden md:flex space-x-8 items-center">
                <a href="{% url 'home' %}" class="text-indigo-700 hover:text-indigo-900 font-bold">Home</a>
                <a href="{% url 'features' %}" class="text-gray-600 hover:text-indigo-700 font-medium">Features</a>
                <a href="{% url 'about' %}" class="text-gray-600 hover:text-indigo-700 font-medium">About</a>
                {% if user.is_authenticated %}
                    <a href="{% url 'profile_dashboard' %}" class="text-gray-600 hover:text-indigo-700 font-medium">Profile</a>
                    <form action="{% url 'logout' %}" method="post" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 shadow-md">Logout</button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="text-gray-600 hover:text-indigo-700 font-medium">Login</a>
                    <a href="{% url 'register' %}" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 shadow-md">Sign Up</a>
                {% endif %}
            </div>
            <button class="md:hidden text-gray-600 hover:text-indigo-700" id="mobileMenuButton">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>
        <div class="md:hidden mt-4 space-y-2 px-4 py-2 bg-gray-50 rounded-lg shadow-sm hidden" id="mobileMenu"></div>
    </nav>

    <header class="relative text-white py-20 md:py-32 rounded-bl-3xl rounded-br-3xl shadow-xl mb-12 overflow-hidden" style="background-image: url('{% static 'images/bg2.jpg' %}'); background-size: cover; background-position: center;">
        <div class="absolute inset-0 bg-black opacity-20 backdrop-blur-sm"></div>
        <div class="container mx-auto text-center px-4 relative z-10">
            {% if user.is_authenticated %}
                <h1 class="text-4xl md:text-6xl font-extrabold mb-6">Welcome back, {{ user.username }}!</h1>
                <p class="text-lg md:text-xl mb-10 max-w-2xl mx-auto opacity-90">Find the closest HAUspital partner near you.</p>
                <a href="{% url 'profile_dashboard' %}" class="inline-block bg-white text-indigo-700 hover:bg-gray-100 font-bold py-3 px-8 rounded-full shadow-lg">Go to Dashboard</a>
            {% else %}
                <h1 class="text-4xl md:text-6xl font-extrabold mb-6">Welcome to HAUspital</h1>
                <p class="text-lg md:text-xl mb-10 max-w-2xl mx-auto opacity-90">Your trusted partner in health.</p>
                <a href="{% url 'register' %}" class="inline-block bg-white text-indigo-700 hover:bg-gray-100 font-bold py-3 px-8 rounded-full shadow-lg">Book an Appointment</a>
            {% endif %}
        </div>
    </header>

    <div class="container mx-auto py-12 px-4">
        {% if user.is_authenticated %}
            <section class="mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-8">Hospitals Near You</h2>

                <div class="map-layout-container">
                    <div id="results-list-container">
                        <div id="results-list">
                            <div class="p-4 text-center text-gray-500">Searching for hospitals...</div>
                        </div>
                    </div>
                    <div id="map-container">
                        <div id="map"></div>
                    </div>
                </div>

                <div id="map-error" class="hidden mt-4 p-4 bg-red-100 text-red-800 rounded-lg shadow-sm"></div>
            </section>
        {% else %}
            <section class="mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-10">Why Choose HAUspital?</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-2xl shadow-lg"><h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Expert Medical Staff</h3></div>
                    <div class="bg-white p-8 rounded-2xl shadow-lg"><h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">State-of-the-Art Facilities</h3></div>
                    <div class="bg-white p-8 rounded-2xl shadow-lg"><h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Patient-Centered Care</h3></div>
                </div>
            </section>
        {% endif %}
    </div>

    <footer class="bg-gray-800 text-gray-300 py-8 mt-12 rounded-t-xl">
        <div class="container mx-auto text-center px-4">
            <p>© 2025 HAUspital. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        {% if user.is_authenticated %}
        document.addEventListener('DOMContentLoaded', () => {
            const geoapifyApiKey = '8a2011283bd148e489e83a87175f641d';

            const mapElement = document.getElementById('map');
            const resultsListElement = document.getElementById('results-list');
            const mapErrorElement = document.getElementById('map-error');
            const mapLayoutContainer = document.querySelector('.map-layout-container');

            const showError = (message) => {
                mapErrorElement.textContent = message;
                mapErrorElement.classList.remove('hidden');
                mapLayoutContainer.style.display = 'none';
            };

            if (!navigator.geolocation) {
                showError("Geolocation is not supported by your browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    const map = L.map('map').setView([userLat, userLon], 13);
                    L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey=${geoapifyApiKey}`, {
                        attribution: 'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>'
                    }).addTo(map);

                    const userIcon = L.icon({ iconUrl: `https://api.geoapify.com/v1/icon/?type=material&color=%231e90ff&icon=person&iconSize=large&apiKey=${geoapifyApiKey}`, iconSize: [38, 55], iconAnchor: [19, 53] });
                    const hospitalIcon = L.icon({ iconUrl: `https://api.geoapify.com/v1/icon/?type=material&color=%23ff3333&icon=local_hospital&iconSize=large&apiKey=${geoapifyApiKey}`, iconSize: [38, 55], iconAnchor: [19, 53] });
                    const hospitalIconHighlight = L.icon({ iconUrl: `https://api.geoapify.com/v1/icon/?type=material&color=%23b60000&icon=local_hospital&iconSize=xlarge&apiKey=${geoapifyApiKey}`, iconSize: [46, 66], iconAnchor: [23, 64] });

                    L.marker([userLat, userLon], { icon: userIcon }).addTo(map).bindTooltip("Your Location");

                    const placesApiUrl = `https://api.geoapify.com/v2/places?categories=healthcare.hospital&filter=circle:${userLon},${userLat},5000&bias=proximity:${userLon},${userLat}&limit=20&apiKey=${geoapifyApiKey}`;

                    fetch(placesApiUrl)
                        .then(response => response.json())
                        .then(data => {
                            resultsListElement.innerHTML = ''; // Clear "Searching..."

                            if (data.features.length === 0) {
                                resultsListElement.innerHTML = '<div class="p-4 text-center text-gray-500">No hospitals found within 5km.</div>';
                                return;
                            }

                            data.features.forEach(place => {
                                const placeProps = place.properties;
                                const marker = L.marker([placeProps.lat, placeProps.lon], { icon: hospitalIcon }).addTo(map);

                                const listItem = document.createElement('div');
                                listItem.className = 'result-item';
                                listItem.innerHTML = `<div class="result-item-name">${placeProps.name || 'N/A'}</div><div class="result-item-address">${placeProps.address_line2 || ''}</div>`;

                                resultsListElement.appendChild(listItem);

                                listItem.addEventListener('mouseover', () => {
                                    marker.setIcon(hospitalIconHighlight);
                                    marker.setZIndexOffset(1000);
                                });
                                listItem.addEventListener('mouseout', () => {
                                    marker.setIcon(hospitalIcon);
                                    marker.setZIndexOffset(0);
                                });
                                listItem.addEventListener('click', () => {
                                    map.flyTo([placeProps.lat, placeProps.lon], 15);
                                });
                            });
                        })
                        .catch(err => {
                             showError("Could not fetch nearby hospitals.");
                        });
                },
                (error) => {
                    let errorMessage = "An unknown error occurred.";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "Location permission denied. Please enable it in your browser settings to use this feature.";
                    }
                    showError(errorMessage);
                }
            );
        });
        {% endif %}
    </script>

</body>
</html>